From 9cef051295892aad048084aebec318570799c2c1 Mon Sep 17 00:00:00 2001
From: OpenEmbedded <oe.patch@oe>
Date: Thu, 27 Jun 2024 08:43:15 -0700
Subject: [PATCH] Linux kernel patch for TX2 on J120 carrier board with Auvidea
 firmware v3.0.

---
 ...6-quill-p3310-1000-a00-plugin-manager.dtsi | 72 ++++++++--------
 .../tegra186-quill-p3310-1000-a00-00-base.dts | 48 ++++++++---
 .../tegra186-quill-p3310-1000-c03-00-base.dts | 83 ++++++++++++++++++-
 3 files changed, 154 insertions(+), 49 deletions(-)

diff --git a/nvidia/platform/t18x/common/kernel-dts/t18x-common-plugin-manager/tegra186-quill-p3310-1000-a00-plugin-manager.dtsi b/nvidia/platform/t18x/common/kernel-dts/t18x-common-plugin-manager/tegra186-quill-p3310-1000-a00-plugin-manager.dtsi
index 90f53bf411c9..4366155fa3fc 100644
--- a/nvidia/platform/t18x/common/kernel-dts/t18x-common-plugin-manager/tegra186-quill-p3310-1000-a00-plugin-manager.dtsi
+++ b/nvidia/platform/t18x/common/kernel-dts/t18x-common-plugin-manager/tegra186-quill-p3310-1000-a00-plugin-manager.dtsi
@@ -85,21 +85,21 @@
 #if TEGRA_XUSB_PADCONTROL_VERSION >= DT_VERSION_2
 				target = <&xusb_padctl>;
 				_overlay_ {
-					ports {
+					/*ports {
 						usb3-0 {
 							status = "okay";
 						};
-					};
+					};*/
 				};
 #else
 				target = <&tegra_xusb_padctl_pinmux_default>;
 				_overlay_ {
-					e3325-usb3-std-A-HS {
+					/*e3325-usb3-std-A-HS {
 						status = "okay";
 					};
 					e3325-usb3-std-A-SS {
 						status = "okay";
-					};
+					};*/
 				};
 #endif
 			};
@@ -117,11 +117,11 @@
 #else
 				_overlay_ {
 					phys = <&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(0)>,
-							<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(1)>,
-							<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(1)>,
-							<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(2)>,
-							<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(0)>;
-					phy-names = "utmi-0", "utmi-1", "usb3-1", "utmi-2", "usb3-0";
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(1)>,
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(2)>,
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(0)>,
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(1)>;
+					phy-names = "utmi-0", "utmi-1", "utmi-2", "usb3-0", "usb3-1";
 				};
 #endif
 			};
@@ -140,10 +140,10 @@
 				target = <&tegra_pcie>;
 				_overlay_ {
 					pci@1,0 {
-						nvidia,num-lanes = <2>;
+						nvidia,num-lanes = <4>;
 					};
 					pci@2,0 {
-						nvidia,num-lanes = <1>;
+						nvidia,num-lanes = <0>;
 					};
 					pci@3,0 {
 						nvidia,num-lanes = <1>;
@@ -212,16 +212,18 @@
 					phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>,
 						<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-1}>,
 						<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-2}>,
-						<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-0}>;
-					phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-0";
+						<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-0}>,
+						<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-1}>;
+					phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-0", "usb3-1";
 				};
 #else
 				_overlay_ {
 					phys = <&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(0)>,
 						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(1)>,
 						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(2)>,
-						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(0)>;
-					phy-names = "utmi-0", "utmi-1", "utmi-2", "usb3-0";
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(0)>,
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(1)>;
+					phy-names = "utmi-0", "utmi-1", "utmi-2", "usb3-0", "usb3-1";
 				};
 #endif
 			};
@@ -230,24 +232,24 @@
 				target = <&xusb_padctl>;
 				_overlay_ {
 					ports {
-						usb3-1 {
+						/*usb3-1 {
 							status = "disabled";
 						};
 						usb3-0 {
 							nvidia,usb2-companion = <1>;
 							status = "okay";
-						};
+						};*/
 					};
 				};
 #else
 				target = <&tegra_xusb_padctl_pinmux_default>;
 				_overlay_ {
-					usb3-std-A-port2 {
+					/*usb3-std-A-port2 {
 						nvidia,lanes = "usb3-0";
 					};
 					e3325-usb3-std-A-HS {
 						status = "okay";
-					};
+					};*/
 				};
 #endif
 			};
@@ -262,15 +264,19 @@
 				_overlay_ {
 					phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>,
 						<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-1}>,
-						<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-2}>;
-					phy-names = "usb2-0", "usb2-1", "usb2-2";
+						<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-2}>,
+						<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-0}>,
+						<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-1}>;
+					phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-0", "usb3-1";
 				};
 #else
 				_overlay_ {
 					phys = <&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(0)>,
 						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(1)>,
-						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(2)>;
-					phy-names = "utmi-0", "utmi-1", "utmi-2";
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(2)>,
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(0)>,
+						<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(1)>;
+					phy-names = "utmi-0", "utmi-1", "utmi-2", "usb3-0", "usb3-1";
 				};
 #endif
 			};
@@ -278,18 +284,18 @@
 #if TEGRA_XUSB_PADCONTROL_VERSION >= DT_VERSION_2
 				target = <&xusb_padctl>;
 				_overlay_ {
-					ports {
-						usb3-0 {
-							status = "disabled";
-						};
-					};
+					//ports {
+					//	usb3-0 {
+					//		status = "disabled";
+					//	};
+					//};
 				};
 #else
 				target = <&tegra_xusb_padctl_pinmux_default>;
 				_overlay_ {
-					usb3-std-A-port2 {
-						status = "disabled";
-					};
+					//usb3-std-A-port2 {
+					//	status = "disabled";
+					//};
 				};
 #endif
 			};
@@ -297,9 +303,9 @@
 			override@2 {
 				target = <&tegra_main_gpio>;
 				_overlay_ {
-					pcie0_lane2_mux {
+					/*pcie0_lane2_mux {
 						status = "okay";
-					};
+					};*/
 				};
 			};
 		};
diff --git a/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-a00-00-base.dts b/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-a00-00-base.dts
index f498a54bb104..f6fe86673915 100644
--- a/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-a00-00-base.dts
+++ b/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-a00-00-base.dts
@@ -122,16 +122,19 @@
 		phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>,
 			<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-1}>,
 			<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-2}>,
+			<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-0}>,
 			<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-1}>;
-		phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-1";
+		phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-0", "usb3-1";
 	};
 #else
 	xhci@3530000 {
 		status = "okay";
 		phys = <&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(0)>,
 			<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(1)>,
+			<&tegra_xusb_padctl TEGRA_PADCTL_PHY_UTMI_P(2)>,
+			<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(0)>,
 			<&tegra_xusb_padctl TEGRA_PADCTL_PHY_USB3_P(1)>;
-		phy-names = "utmi-0", "utmi-1", "usb3-1";
+		phy-names = "utmi-0", "utmi-1", "utmi-2", "usb3-0", "usb3-1";
 		nvidia,boost_cpu_freq = <800>;
 	};
 #endif
@@ -176,10 +179,10 @@
 						nvidia,function = "xusb";
 						status = "okay";
 					};
-					usb3-2 {
+					/*usb3-2 {
 						nvidia,function = "xusb";
 						status = "okay";
-					};
+					};*/
 				};
 			};
 		};
@@ -200,10 +203,12 @@
 			usb2-2 {
 				status = "okay";
 				mode = "host";
-				vbus-supply = <&vdd_usb2_5v>;
+				vbus-supply = <&battery_reg>;
+				nvidia,oc-pin = <1>;
 			};
 			usb3-0 {
 				nvidia,usb2-companion = <2>;
+				status = "okay";
 			};
 			usb3-1 {
 				nvidia,usb2-companion = <1>;
@@ -228,50 +233,69 @@
 		tegra_xusb_padctl_pinmux_default: pinmux {
 			/* Quill does not support usb3-micro AB */
 			usb2-micro-AB {
+				status = "okay";
 				nvidia,lanes = "otg-0";
 				nvidia,function = "xusb";
 				nvidia,port-cap = <TEGRA_PADCTL_PORT_OTG_CAP>;
 				nvidia,oc-pin = <0>;
 			};
 			usb2-std-A-port2 {
+				status = "okay";
 				nvidia,lanes = "otg-1";
 				nvidia,function = "xusb";
 				nvidia,port-cap = <TEGRA_PADCTL_PORT_HOST_ONLY>;
 				nvidia,oc-pin = <1>;
 			};
+			usb2-std-A-port3 {
+				status = "okay";
+				nvidia,lanes = "otg-2";
+				nvidia,function = "xusb";
+				nvidia,port-cap = <TEGRA_PADCTL_PORT_HOST_ONLY>;
+				nvidia,oc-pin = <1>;
+			};
+
 			usb3-std-A-port2 {
+				status = "okay";
 				nvidia,lanes = "usb3-1";
 				nvidia,port-cap = <TEGRA_PADCTL_PORT_HOST_ONLY>;
 				nvidia,oc-pin = <1>;
 			};
+		
+			usb3-std-A-port3 {
+				status = "okay";
+				nvidia,lanes = "usb3-0";
+				nvidia,port-cap = <TEGRA_PADCTL_PORT_HOST_ONLY>;
+				nvidia,oc-pin = <1>;
+			};
 
-			e3325-usb3-std-A-HS {
+			/*e3325-usb3-std-A-HS {
 				nvidia,lanes = "otg-2";
 				nvidia,function = "xusb";
 				nvidia,port-cap = <TEGRA_PADCTL_PORT_HOST_ONLY>;
-				status = "disabled";
+				//status = "disabled";
+				status = "okay";
 			};
 
 			e3325-usb3-std-A-SS {
 				nvidia,lanes = "usb3-0";
 				nvidia,port-cap = <TEGRA_PADCTL_PORT_HOST_ONLY>;
 				status = "disabled";
-			};
+			};*/
 		};
 	};
 	pcie-controller@10003000 {
 		status = "okay";
 		pci@1,0 {
-			nvidia,num-lanes = <2>;
+			nvidia,num-lanes = <4>;
 			status = "okay";
 		};
 		pci@2,0 {
-			nvidia,num-lanes = <1>;
-			status = "disabled";
+			nvidia,num-lanes = <0>;
+			status = "okay";
 		};
 		pci@3,0 {
 			nvidia,num-lanes = <1>;
-			status = "okay";
+			status = "disabled";
 		};
 	};
 
diff --git a/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-c03-00-base.dts b/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-c03-00-base.dts
index 868be40d1b37..08f508fb6303 100644
--- a/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-c03-00-base.dts
+++ b/nvidia/platform/t18x/quill/kernel-dts/tegra186-quill-p3310-1000-c03-00-base.dts
@@ -112,7 +112,7 @@
 	pcie-controller@10003000 {
 		pci@1,0 {
 			nvidia,num-lanes = <4>;
-			nvidia,disable-clock-request;
+			//nvidia,disable-clock-request;
 		};
 		pci@2,0 {
 			nvidia,num-lanes = <0>;
@@ -126,15 +126,16 @@
 		phys = <&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-0}>,
 			<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-1}>,
 			<&{/xusb_padctl@3520000/pads/usb2/lanes/usb2-2}>,
-			<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-0}>;
-		phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-0";
+			<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-0}>,
+			<&{/xusb_padctl@3520000/pads/usb3/lanes/usb3-1}>;
+		phy-names = "usb2-0", "usb2-1", "usb2-2", "usb3-0", "usb3-1";
 		nvidia,boost_cpu_freq = <1200>;
 	};
 
 	xusb_padctl@3520000 {
 		ports {
 			usb3-1 {
-				status = "disabled";
+				status = "okay";
 			};
 			usb3-0 {
 				nvidia,usb2-companion = <1>;
@@ -143,6 +144,80 @@
 		};
 	};
 
+		
+	/delete-node/ spi@c260000;						//deleted(fd)
+
+	spi1: spi@c260000 {							//new added(fd)
+		status="okay";
+		compatible = "nvidia,tegra186-spi";
+		reg = <0x0 0x0c260000 0x0 0x10000>;
+		interrupts = <0 37 0x04>;
+		#address-cells = <1>;
+		#size-cells = <0>;
+		iommus = <&smmu TEGRA_SID_GPCDMA_0>;
+		dmas = <&gpcdma 16>, <&gpcdma 16>;
+		dma-names = "rx", "tx";
+		nvidia,clk-parents = "pll_p", "osc";
+		spi-max-frequency = <25000000>;
+		clocks = <&tegra_car TEGRA186_CLK_SPI2>,
+			<&tegra_car TEGRA186_CLK_PLLP_OUT0>,
+			<&tegra_car TEGRA186_CLK_OSC>;
+		clock-names = "spi", "pll_p", "osc";
+		resets = <&tegra_car TEGRA186_RESET_SPI2>;
+		reset-names = "spi";
+			
+		spi1_0 {
+			status = "okay";
+			#address-cells = <0x1>;
+			#size-cells = <0x0>;
+			compatible = "spidev";
+			reg = <0>;
+			spi-max-frequency = <25000000>;
+			nvidia,enable-hw-based-cs;
+			nvidia,cs-setup-clk-count = <0x1e>;
+			nvidia,cs-hold-clk-count = <0x1e>;
+			nvidia,rx-clk-tap-delay = <0x1f>;
+			nvidia,tx-clk-tap-delay = <0x0>;			
+
+			irq-gpio = <&tegra_aon_gpio TEGRA_AON_GPIO(AA, 2) 0x01>;
+			interrupt-parent = <&tegra_aon_gpio>;
+			interrupts = <TEGRA_AON_GPIO(AA, 2) 0x01>; // GPIO_PAA2
+		};
+	};
+
+	spi@3230000 {			//new(fd)
+		status="okay";
+		spi2_0 {
+			compatible = "spidev";
+			status = "okay";
+			reg = <0>;
+			spi-max-frequency = <25000000>;			
+		};
+		spi2_1 {
+			compatible = "spidev";
+			status = "okay";
+			reg = <1>;
+			spi-max-frequency = <25000000>;			
+		};
+	};
+
+
+	spi@3240000 {			//new(fd)
+		status="okay";
+		spi3_0 {
+			compatible = "spidev";
+			status = "okay";
+			reg = <0>;
+			spi-max-frequency = <25000000>;			
+		};
+		spi3_1 {
+			compatible = "spidev";
+			status = "okay";
+			reg = <1>;
+			spi-max-frequency = <25000000>;			
+		};
+	};
+
        bluedroid_pm {
 		bluedroid_pm,reset-gpio = <&tegra_main_gpio TEGRA_MAIN_GPIO(H, 5) 0>;
         };
